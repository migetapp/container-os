# Copyright 2025 Miget (https://miget.com)
# Licensed under the Apache License, Version 2.0

name: Regenerate Dockerfiles

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.3). Leave empty for auto-bump.'
        required: false
        type: string
      bump_type:
        description: 'Version bump type (ignored if version is specified)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  schedule:
    - cron: "0 5 * * *"

jobs:
  regenerate:
    name: Refresh Dockerfiles and Create Release PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install requests packaging
      
      - name: Fetch latest docker-compose version
        run: python scripts/update_docker_compose_version.py
      
      - name: Fetch latest package versions
        run: python scripts/update_manifest_versions.py
      
      - name: Record Ubuntu base digests
        run: |
          python scripts/check_ubuntu_digest.py 22.04 --record || true
          python scripts/check_ubuntu_digest.py 24.04 --record || true
      
      - name: Check for significant changes
        id: check_changes
        run: |
          # Always run detect_changes.py to report what changed
          if python scripts/detect_changes.py; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Significant changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No significant changes detected"
          fi
          
          # Manual version input forces a release regardless of changes
          if [ -n "${{ inputs.version }}" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Manual version specified: ${{ inputs.version }} - forcing release"
          fi
        continue-on-error: true
      
      - name: Set version
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "Setting explicit version: ${{ inputs.version }}"
            python -c "
          import json
          with open('manifests/targets.json', 'r') as f:
              data = json.load(f)
          data['version'] = '${{ inputs.version }}'
          with open('manifests/targets.json', 'w') as f:
              json.dump(data, f, indent=2)
              f.write('\n')
          "
          elif [ "${{ inputs.bump_type }}" = "minor" ]; then
            echo "Bumping minor version"
            python scripts/bump_version.py --minor
          elif [ "${{ inputs.bump_type }}" = "major" ]; then
            echo "Bumping major version"
            python scripts/bump_version.py --major
          else
            echo "Bumping patch version"
            python scripts/bump_version.py
          fi
      
      - name: Render Dockerfiles
        run: python scripts/render_dockerfiles.py
      
      - name: Update README component versions table
        run: python scripts/update_readme_table.py
      
      - name: Update README tag table
        run: python scripts/update_readme_tags.py
      
      - name: Generate changelog entry
        run: python scripts/update_changelog.py --auto
      
      - name: Get new version
        id: version
        run: |
          VERSION=$(python -c "import json; print(json.load(open('manifests/targets.json'))['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "New version: $VERSION"
      
      - name: Configure git
        run: |
          git config user.name "miget-bot"
          git config user.email "bot@miget.dev"
      
      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: release v${{ steps.version.outputs.version }}"
          branch: release/v${{ steps.version.outputs.version }}
          title: "Release v${{ steps.version.outputs.version }}"
          body: |
            ## Release v${{ steps.version.outputs.version }}
            
            Automated release with updated components:
            - Docker Compose, Docker CE, Podman, or base OS versions updated
            - Dockerfiles regenerated from templates
            - README and changelog updated
            
            ### Changes
            - Updated package versions in manifests
            - Regenerated all Dockerfiles
            - Updated component versions table in README
            - Updated changelog
            
            **This PR will trigger image builds and publishing on merge.**
          labels: |
            release
            automated

